<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Meat Dept Spot Finder</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 16px; }
    button { font-size: 18px; padding: 10px 12px; }
    #video { width: 100%; max-height: 50vh; background: #000; border-radius: 12px; }
    #result { margin-top: 12px; padding: 14px; border-radius: 12px; background: #f4f4f4; }
    .big { font-size: 34px; font-weight: bold; }
    textarea { width: 100%; min-height: 120px; margin-top: 10px; }
  </style>
</head>
<body>

<h2>Meat Dept Spot Finder</h2>
<button id="startBtn">Start Camera Scan</button>
<button id="stopBtn" disabled>Stop</button>

<video id="video" autoplay playsinline></video>

<div id="result">
  <div class="big" id="spotText">Scan a UPC</div>
  <div id="descText">â€”</div>
  <div id="upcText"></div>
</div>

<h3>Edit Product List</h3>
<p>Format: UPC,SPOT,ZONE,DESCRIPTION</p>
<textarea id="dbEditor">
044700012345,2,B,Oscar Mayer Ham
028000000111,1,A,Lunchables Turkey & Cheddar
021130012222,3,B,Bacon
</textarea>
<button id="saveDbBtn">Save List</button>

<script>
const video = document.getElementById("video");
const spotText = document.getElementById("spotText");
const descText = document.getElementById("descText");
const upcText  = document.getElementById("upcText");
const startBtn = document.getElementById("startBtn");
const stopBtn  = document.getElementById("stopBtn");
const dbEditor = document.getElementById("dbEditor");

let dbMap = new Map();
function parseDb() {
  dbMap.clear();
  dbEditor.value.split("\n").forEach(line => {
    const parts = line.trim().split(",");
    if (parts.length >= 3) {
      const upc = parts[0].replace(/\D/g,"");
      dbMap.set(upc, { spot: parts[1], zone: parts[2], desc: parts.slice(3).join(",") });
    }
  });
}
parseDb();

document.getElementById("saveDbBtn").onclick = () => parseDb();

function beep(times) {
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  for (let i = 0; i < times; i++) {
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.frequency.value = 880;
    o.connect(g);
    g.connect(ctx.destination);
    g.gain.setValueAtTime(0.2, ctx.currentTime);
    o.start(ctx.currentTime);
    o.stop(ctx.currentTime + 0.1);
  }
}

function showHit(upc) {
  const hit = dbMap.get(upc);
  if (hit) {
    spotText.textContent = "SPOT " + hit.spot + hit.zone;
    descText.textContent = hit.desc;
    upcText.textContent  = "UPC: " + upc;
    beep(parseInt(hit.spot) || 1);
  } else {
    spotText.textContent = "NOT FOUND";
    descText.textContent = "Add this UPC below.";
    upcText.textContent  = "UPC: " + upc;
  }
}

let stream, scanning=false;
startBtn.onclick = async () => {
  if (!("BarcodeDetector" in window)) {
    alert("Use Chrome or Edge on Android.");
    return;
  }
  const detector = new BarcodeDetector({ formats: ["upc_a","ean_13","ean_8","code_128"] });
  stream = await navigator.mediaDevices.getUserMedia({ video:{facingMode:"environment"} });
  video.srcObject = stream;
  scanning = true;
  startBtn.disabled=true;
  stopBtn.disabled=false;

  const loop = async () => {
    if (!scanning) return;
    const codes = await detector.detect(video);
    if (codes.length) {
      const upc = codes[0].rawValue.replace(/\D/g,"");
      showHit(upc);
      scanning=false; // pause after one scan
    }
    requestAnimationFrame(loop);
  };
  requestAnimationFrame(loop);
};

stopBtn.onclick = () => {
  scanning=false;
  startBtn.disabled=false;
  stopBtn.disabled=true;
  if (stream) stream.getTracks().forEach(t=>t.stop());
};
</script>

</body>
</html>
